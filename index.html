<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>MCSR Rules</title>
  <meta name="description" content="The official ruleset for Minecraft Speedrunning.">
  <link rel="stylesheet" href="styles.css">
  <link rel="icon" type="image/png" sizes="128x128" href="assets/favicon.png"> <!-- website icon -->
  <script>
 	document.addEventListener('DOMContentLoaded', () => {
    const jsWarn = document.getElementById('js');
    if (jsWarn) jsWarn.remove();

    const releasesEl = document.getElementById('releases');
    const quicklink = document.getElementById('quicklink');
    const newestEl = document.getElementById('newest');


    fetch('https://api.github.com/repos/Minecraft-Java-Edition-Speedrunning/rules/contents/pub/pdf')
      .then(res => {
        if (!res.ok) {
          if (newestEl) newestEl.innerText = 'github api failed :(';
          throw new Error('GitHub API returned ' + res.status);
        }
        return res.json();
      })
      .then(data => {
        data.sort((a, b) => {
          const an = a.name, bn = b.name;
          const aStable = !/beta/i.test(an);
          const bStable = !/beta/i.test(bn);
          if (aStable !== bStable) return aStable ? -1 : 1; 

          const aMatch = an.match(/([0-9]+(?:[._][0-9]+)*)/);
          const bMatch = bn.match(/([0-9]+(?:[._][0-9]+)*)/);
          if (aMatch && bMatch) {
            const aNums = aMatch[1].replace(/_/g, '.').split('.').map(x => parseInt(x, 10) || 0);
            const bNums = bMatch[1].replace(/_/g, '.').split('.').map(x => parseInt(x, 10) || 0);
            const n = Math.max(aNums.length, bNums.length);
            for (let i = 0; i < n; i++) {
              const ai = aNums[i] || 0;
              const bi = bNums[i] || 0;
              if (ai !== bi) return bi - ai; 
            }
          }
          return bn.localeCompare(an);
        });

        if (!data || data.length === 0) {
          if (newestEl) newestEl.innerText = 'No releases found';
          if (releasesEl) releasesEl.innerHTML = '<li class="loading">No releases found</li>';
          return;
        }

        const newest = data[0];
        const newestURL = 'https://rawcdn.githack.com/Minecraft-Java-Edition-Speedrunning/rules/main/pub/pdf/' + encodeURIComponent(newest.name);

        if (quicklink) {
          quicklink.href = newestURL;
          quicklink.innerText = newest.name;
        } else if (newestEl) {
          newestEl.innerHTML = `Current: <a href="${newestURL}" target="_blank" rel="noopener noreferrer">${newest.name}</a>`;
        }

        if (releasesEl) releasesEl.innerHTML = '';
        for (const ver of data) {
          const li = document.createElement('li');
          const url = 'https://rawcdn.githack.com/Minecraft-Java-Edition-Speedrunning/rules/main/pub/pdf/' + encodeURIComponent(ver.name);
          const tag = ver.name.split('.')[0];
          if (!/beta/i.test(ver.name)) {
            const changelog = 'https://github.com/Minecraft-Java-Edition-Speedrunning/rules/releases/tag/' + encodeURIComponent(tag);
            li.innerHTML = `<a class="release-link" href="${url}" target="_blank" rel="noopener noreferrer">${ver.name}</a><span class="sep"> â€” </span><a class="changelog-link" href="${changelog}" target="_blank" rel="noopener noreferrer">Changelog</a>`;
          } else {
            li.innerHTML = `<a class="release-link" href="${url}" target="_blank" rel="noopener noreferrer">${ver.name}</a><span class="sep"> </span><em class="beta">(beta)</em>`;
          }
          releasesEl.appendChild(li);
        }
      })
      .catch(err => {
        console.error(err);
        if (newestEl) newestEl.innerText = 'Failed to load releases';
        if (releasesEl) releasesEl.innerHTML = `<li>Failed to fetch releases: ${err.message}</li>`;
      });
  });
  </script>
</head>

<body>
  <main class="page">
    <header class="site-header">
      <div class="brand">
      	<img src="assets/favicon.png" alt="MCSR Rules Logo" class="brand-icon" width="32" height="32">
        <div>
          <h1>MCSR Rules</h1>
          <p class="subtitle">The official ruleset for Minecraft Speedrunning.</p>
        </div>
      </div>
      <nav class="header-nav">
        <a class="btn" href="https://github.com/Minecraft-Java-Edition-Speedrunning/rules" target="_blank" rel="noopener noreferrer">GitHub</a>
      </nav>
    </header>

    <section class="content-area">
      <h2 id="js">This site requires JavaScript!</h2>

      <div class="current-line" id="newest">Current: <a id="quicklink">Loading..</a></div>
      <div class="rules-list-wrap">
        <h3 id="rules">All releases:</h3>
        <ul id="releases" class="releases">
          <li class="loading">Loading releases..</li>
        </ul>
		<p class="note">
		  The rules are maintained on GitHub at <a href="https://github.com/Minecraft-Java-Edition-Speedrunning/rules">Minecraft-Java-Edition-Speedrunning/rules</a>.<br>
		  Use <a href="./latest">/latest</a> to always redirect to the current rules release.
		</p>
      </div>
    </section>
  </main>
</body>

</html>
